{% extends 'base.html' %}
{% load static %}
{% block content %}
<section class="py-5 text-center bg-light ">
    <div class="container mt-5">
        <!-- Messages -->
        {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
            <div class="alert 
                        {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}alert-danger
                        {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}alert-warning
                        {% elif message.level == DEFAULT_MESSAGE_LEVELS.INFO %}alert-info
                        {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}alert-success
                        {% else %}alert-secondary{% endif %}">
                {{ message }}
                <button type="button" class="btn btn-close  btn-danger" data-bs-dismiss="alert"
                    aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <h3>Welcome to My Real Time Task Management System </h3>
        <p class="lead">See All Notifications</p>

        <div class="d-flex justify-content-center mb-3">
            <button id="btnAll" class="btn btn-secondary me-2">All</button>
            <button id="btnRead" class="btn btn-success me-2">Read</button>
            <button id="btnUnread" class="btn btn-warning">Unread</button>
        </div>

        <!-- Notification List -->
        <div id="notificationList" class="mt-4">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Sender</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="notificationsBody"></tbody>

            </table>
        </div>
    </div>
</section>

<script>
    let allnotification = [];
    async function fetchnotifications() {
        const accessToken = localStorage.getItem("access_token"); // JWT token
        const tbody = document.getElementById("notificationsBody");
        tbody.innerHTML = ""; // Clear existing rows

        try {
            const response = await fetch("http://127.0.0.1:8000/notifications/notificationlist/", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + accessToken,
                    "Content-Type": "application/json"
                }
            });

            const data = await response.json();

            if (response.ok){
                allnotification = data;
                renderNotifications(allnotification);
            }else{
                console.error("Error fetching notifications:", data);
            }
        }
        catch (error) {
            console.error("Error fetching notifications:", error);
        }
    }


    function renderNotifications(notifications) {
        const tbody = document.getElementById("notificationsBody");
        tbody.innerHTML = "";

        notifications.forEach(notification => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${notification.notification_type}</td>
                <td>${notification.message}</td>
                <td>${notification.is_read ? "Read" : "Unread"}</td>
                <td>${notification.sender_name}</td>
                <td>${new Date(notification.create_at).toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Button click events
    document.getElementById("btnAll").addEventListener("click", () => renderNotifications(allnotification));
    document.getElementById("btnRead").addEventListener("click", () => renderNotifications(allnotification.filter(n => n.is_read)));
    document.getElementById("btnUnread").addEventListener("click", () => renderNotifications(allnotification.filter(n => !n.is_read)));

    // Call the function
    fetchnotifications();


</script>




{% endblock %}